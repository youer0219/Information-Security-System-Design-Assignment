
## 实验三	密码模块实现

### 4-6 学时实践要求（30 分）

1. 在 Ubuntu或openEuler中（推荐 openEuler）中调用GmSSL代码，至少实现SM2，SM3，SM4相关密码算法接口，使用Markdown记录详细记录实践过程，每完成一项功能或者一个函数git commit 一次。（10分）
2. 在 Ubuntu或openEuler中（推荐 openEuler）中调用GmSSL代码，实现SM2，SM4相关接口密钥管理功能及其他必要接口。使用Markdown记录详细记录实践过程，每完成一项功能或者一个函数git commit 一次。（10分）
3. 使用 Rust 实现相关接口（选做，10 分）
4. 实验记录中提交 gitee 课程项目链接，提交本次实验相关 git log运行结果。
5. 提交要求：

- 提交实践过程Markdown和转化的PDF文件
- 代码，文档托管到gitee或github等，推荐 gitclone
- 记录实验过程中遇到的问题，解决过程，反思等内容，用于后面实验报告
- []()
- [实验过程文档GitHub链接](https://github.com/youer0219/Information-Security-System-Design-Assignment)


### 实践过程

#### 前期准备
- 发现GmSSL/SoftSDF库
    - 在使用[kimi查询密钥管理含义](https://kimi.moonshot.cn/share/csurcu7ogfdo32nr1de0)时，从其参考网站中发现了[GmSSL/SoftSDF库](https://github.com/GmSSL/SoftSDF)。
        - ![](https://i-blog.csdnimg.cn/direct/130480d0e8b840c0b297a98fd3bad891.png)
    - 这是GmSSL官方的SDF密码设备接口的软件实现。尽管一些接口设置可能和我们设备不一样，但实现肯定大同小异
    - 接下来的代码实现基本上参考[库中softsdf.c等代码](https://github.com/GmSSL/SoftSDF/blob/main/softsdf.c)的实现
- 明确哪些函数需要实现
    - 目标：实现SM2，SM3，SM4相关密码算法接口和实现SM2、SM4相关接口密钥管理功能及其他必要接口
        - 密码算法模块：
            - SM2：加解密、签名验签
            - SM3：哈希计算、HMAC
            - SM4：加解密
        - 密钥管理功能：生成和检验、交换和协商、保护和存储、更换和装入
    - [使用AI初步明确需要实现的函数](https://kimi.moonshot.cn/share/csurkjhrdij3j1j8l740)
        ```
        要实现SM2、SM3、SM4相关的密码算法接口以及SM2、SM4的密钥管理功能，可以参考以下函数：

        ### SM2相关函数

        1. **密钥对生成**：
        - `SDF_GenerateKeyPair_ECC`：生成SM2密钥对，包括公钥和私钥。

        2. **公钥导出**：
        - `SDF_ExportSignPublicKey_ECC`：导出用于签名的SM2公钥。
        - `SDF_ExportEncPublicKey_ECC`：导出用于加密的SM2公钥。

        3. **签名和验证**：
        - `SDF_InternalSign_ECC`：使用SM2私钥对数据进行签名。
        - `SDF_InternalVerify_ECC`：使用SM2公钥对签名进行验证。

        4. **加密和解密**：
        - `SDF_InternalEncrypt_ECC`：使用SM2公钥对数据进行加密。
        - `SDF_InternalDecrypt_ECC`：使用SM2私钥对数据进行解密。

        5. **密钥管理**：
        - `SDF_GetPrivateKeyAccessRight`：获取私钥访问权限，通常涉及密码验证。
        - `SDF_ReleasePrivateKeyAccessRight`：释放私钥访问权限。

        ### SM3相关函数

        1. **哈希计算**：
        - `SDF_HashInit`、`SDF_HashUpdate`、`SDF_HashFinal`：这三个函数组合使用，用于初始化哈希计算、更新数据和获取最终的哈希值。

        2. **消息认证码（MAC）计算**：
        - `SDF_CalculateMAC`：使用SM3算法计算消息认证码，通常用于验证数据的完整性和来源。

        ### SM4相关函数

        1. **密钥生成**：
        - `SDF_GenerateKeyWithKEK`：使用密钥加密密钥（KEK）生成SM4密钥。

        2. **密钥导入**：
        - `SDF_ImportKeyWithKEK`：使用KEK导入SM4密钥。

        3. **加密和解密**：
        - `SDF_Encrypt`：使用SM4密钥对数据进行加密。
        - `SDF_Decrypt`：使用SM4密钥对数据进行解密。

        ### 其他必要接口

        1. **设备和会话管理**：
        - `SDF_OpenDevice`、`SDF_CloseDevice`：打开和关闭设备。
        - `SDF_OpenSession`、`SDF_CloseSession`：打开和关闭会话。

        2. **文件操作**：
        - `SDF_CreateFile`、`SDF_ReadFile`、`SDF_WriteFile`、`SDF_DeleteFile`：创建、读取、写入和删除文件。

        这些函数涵盖了SM2、SM3、SM4算法的基本操作，包括密钥管理、加密、解密、签名、验证和哈希计算等。在实现时，需要确保密钥的安全存储、传输和使用，以及算法的正确性和效率。

        ```
- 注意到，sdf.h中自己定义了一些类型变量代替int等常见声明，这在阅读代码时需要额外留心
    ```
    /*类型定义*/
    typedef char          SGD_CHAR;
    typedef int8_t        SGD_INT8;
    typedef int16_t       SGD_INT16;
    typedef int32_t       SGD_INT32;
    typedef int64_t       SGD_INT64;
    typedef unsigned char SGD_UCHAR;
    typedef uint8_t       SGD_UINT8;
    typedef uint16_t      SGD_UINT16;
    typedef uint32_t      SGD_UINT32;
    typedef uint64_t      SGD_UINT64;
    typedef unsigned int  SGD_RV;
    typedef void*         SGD_HANDLE;
    ```
- 如何确定代码实现的正确性呢？
- 按照`先易后难`的传统，先从SM3的密码算法实现开始
#### 调用GmSSL代码实现SM2，SM3，SM4相关密码算法接口
- 复制sdf.h到shiyan03文件夹(直接通过文件资源管理器操作)
    ```
    root@Youer:~/shiyan/shiyan03# ls
    sdf.h
    root@Youer:~/shiyan/shiyan03# git add .
    root@Youer:~/shiyan/shiyan03# git commit -m "cp sdf.h of ch06-rochs0018sdf"
    [master (root-commit) 4e997c0] cp sdf.h of ch06-rochs0018sdf
    1 file changed, 1084 insertions(+)
    create mode 100644 sdf.h
    ```
- 实现SM3相关密码算法接口
    - 第一步：有哪些函数需要实现：`SDF_HashInit`、`SDF_HashUpdate`、`SDF_HashFinal`、`SDF_CalculateMAC`


#### 调用GmSSL代码实现SM2、SM4相关接口密钥管理功能及其他必要接口


